---
- name: nextcloud - google cloud variant
  hosts: localhost
  gather_facts: true
  become: true
  tasks:

    - name: required packages
      apt:
        pkg:
          - docker.io
          - libcap2-bin
          - python3-pip
          - ssl-cert
        state: latest
        update_cache: yes

    - name: docker python packages
      pip:
        name:
          - docker
        executable: /usr/bin/pip3
        state: latest

    - name: IP Forwarding enable/persist
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        reload: yes
        sysctl_set: yes
        sysctl_file: /etc/sysctl.conf

    - name: docker service started/enabled
      systemd:
        name: docker
        state: started
        enabled: True

    - name: db user
      user:
        name: nextclouddb
        shell: /bin/bash
        create_home: False
      register: db_user

    - name: various container directories - application
      file:
        path: "{{ item }}"
        state: directory
        owner: www-data
        mode: '0750'
      with_items:
        - /opt/nextcloud
        - /opt/nextcloud/var
        - /opt/nextcloud/var/www
        - /opt/nextcloud/var/www/html
        - /opt/nextcloud/var/www/html/custom_apps
        - /opt/nextcloud/var/www/html/config
        - /opt/nextcloud/var/www/html/data

    - name: various container directories - webproxy
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0750'
      with_items:
        - /opt/webproxy

    - name: various container directories - db
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ db_user.name }}"
        group: "{{ db_user.group }}"
        mode: '0750'
      with_items:
        - /opt/nextcloud_db

    - name: secure proxy to pihole confs
      template:
        src: "{{ item }}"
        dest: "/opt/webproxy/{{ item }}"
        owner: root
        group: root
        mode: 0444
      with_items:
        - httpd-ssl.conf
        - httpd.conf

    - name: Retrieve GCS Token
      uri:
        url: http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token
        method: GET
        headers:
          Metadata-Flavor: Google
        return_content: yes
      register: gcs_token_resp

    - name: Get admin secret from google secret manager
      uri:
        url: https://secretmanager.googleapis.com/v1/projects/{{ gcp_project_prefix }}-project-{{ gcp_project_suffix }}/secrets/{{ gcp_project_prefix }}-admin-password/versions/latest:access
        method: GET
        remote_src: yes
        return_content: yes
        headers:
          Authorization: Bearer {{ gcs_token_resp.json.access_token }}
          Content-Type: application/json
          x-goog-user-project: "{{ gcp_project_prefix }}-project-{{ gcp_project_suffix }}"
      register: admin_secret

    - name: Get db secret from google secret manager
      uri:
        url: https://secretmanager.googleapis.com/v1/projects/{{ gcp_project_prefix }}-project-{{ gcp_project_suffix }}/secrets/{{ gcp_project_prefix }}-db-password/versions/latest:access
        method: GET
        remote_src: yes
        return_content: yes
        headers:
          Authorization: Bearer {{ gcs_token_resp.json.access_token }}
          Content-Type: application/json
          x-goog-user-project: "{{ gcp_project_prefix }}-project-{{ gcp_project_suffix }}"
      register: db_secret

    - name: Get storage secret from google secret manager
      uri:
        url: https://secretmanager.googleapis.com/v1/projects/{{ gcp_project_prefix }}-project-{{ gcp_project_suffix }}/secrets/{{ gcp_project_prefix }}-storage-key/versions/latest:access
        method: GET
        remote_src: yes
        return_content: yes
        headers:
          Authorization: Bearer {{ gcs_token_resp.json.access_token }}
          Content-Type: application/json
          x-goog-user-project: "{{ gcp_project_prefix }}-project-{{ gcp_project_suffix }}"
      register: storage_key

    - name: Get nextcloud backup from storage if exists
      uri:
        url: https://storage.googleapis.com/{{ gcp_project_prefix }}-bucket-{{ gcp_project_suffix }}/nextcloud/nextcloud_backup.tar.gz
        timeout: 120
        method: GET
        dest: /opt/nextcloud_backup.tar.gz
        remote_src: yes
        return_content: yes
        headers:
          Authorization: Bearer {{ gcs_token_resp.json.access_token }}
      ignore_errors: True

    - name: Determine nextcloud state
      stat:
        path: /opt/nextcloud/var/www/html/data/ncadmin
      register: nextcloud_state

    - name: unarchive backup if dir not exists
      unarchive:
        src: /opt/nextcloud_backup.tar.gz
        dest: /opt/
        remote_src: yes
      when: nextcloud_state.stat.exists|bool == False
      ignore_errors: True

    - name: Get nextcloud backup db from storage if exists
      uri:
        url: https://storage.googleapis.com/{{ gcp_project_prefix }}-bucket-{{ gcp_project_suffix }}/nextcloud/nextcloud_db_backup.tar.gz
        timeout: 120
        method: GET
        dest: /opt/nextcloud_db_backup.tar.gz
        remote_src: yes
        return_content: yes
        headers:
          Authorization: Bearer {{ gcs_token_resp.json.access_token }}
      ignore_errors: True

    - name: Determine nextcloud db state
      stat:
        path: /opt/nextcloud_db/databases/nextcloud
      register: nextcloud_db_state

    - name: unarchive db backup if dir not exists
      unarchive:
        src: /opt/nextcloud_db_backup.tar.gz
        dest: /opt/
        remote_src: yes
        owner: nextclouddb
        group: nextclouddb
      when: nextcloud_db_state.stat.exists|bool == False
      ignore_errors: True

    - name: docker network
      docker_network:
        name: nextcloud
        driver: bridge
        ipam_config:
          - subnet: "{{ docker_network }}/24"
            gateway: "{{ docker_gw }}"

    - name: db container
      docker_container:
        name: nextcloud_database
        hostname: nextclouddb
        image: linuxserver/mariadb:latest
        networks:
          - name: nextcloud
            ipv4_address: "{{ docker_db }}"
        env:
          MYSQL_ROOT_PASSWORD: "{{ admin_secret.json.payload.data | b64decode }}"
          MYSQL_PASSWORD: "{{ db_secret.json.payload.data | b64decode }}"
          MYSQL_DATABASE: nextcloud
          MYSQL_USER: nextcloud
          PUID: "{{ db_user.uid }}"
          PGID: "{{ db_user.group }}"
        volumes:
          - /opt/nextcloud_db:/config:rw
        pull: yes
        purge_networks: yes
        restart_policy: "always"
        container_default_behavior: "compatibility"

    - name: nextcloud container
      docker_container:
        name: nextcloud_application
        hostname: nextcloudapp
        image: nextcloud:latest
        networks:
          - name: nextcloud
            ipv4_address: "{{ docker_nextcloud }}"
        env:
          NEXTCLOUD_ADMIN_PASSWORD: "{{ admin_secret.json.payload.data | b64decode }}"
          NEXTCLOUD_ADMIN_USER: ncadmin
          NEXTCLOUD_TRUSTED_DOMAINS: "{{ instance_public_ip }} {{ docker_webproxy }} {{ docker_nextcloud }}"
          TRUSTED_PROXIES: "{{ instance_public_ip }} {{ docker_webproxy }}"
          OVERWRITEHOST: "{{ instance_public_ip }}"
          OVERWRITEPROTOCOL: https
          MYSQL_PASSWORD: "{{ db_password.json.payload.data | b64decode }}"
          MYSQL_DATABASE: nextcloud
          MYSQL_USER: nextcloud
          MYSQL_HOST: "{{ docker_db }}"
        volumes:
          - /opt/nextcloud/var/www/html:/var/www/html:rw
          - /opt/nextcloud/var/www/html/custom_apps:/var/www/html/custom_apps:rw
          - /opt/nextcloud/var/www/html/config:/var/www/html/config:rw
          - /opt/nextcloud/var/www/html/data:/var/www/html/data:rw
          - /opt/nextcloud/var/www/html/themes:/var/www/html/themes:rw
        pull: yes
        purge_networks: yes
        restart_policy: "always"
        container_default_behavior: "compatibility"

    - name: web proxy container
      docker_container:
        name: nextcloud_web_proxy
        hostname: nextcloudweb
        image: httpd:2.4
        networks:
          - name: nextcloud
            ipv4_address: "{{ docker_webproxy }}"
        ports:
          - "443:443"
        volumes:
          - /opt/webproxy/httpd-ssl.conf:/usr/local/apache2/conf/extra/httpd-ssl.conf:ro
          - /opt/webproxy/httpd.conf:/usr/local/apache2/conf/httpd.conf:ro
          - /etc/ssl/certs/ssl-cert-snakeoil.pem:/usr/local/apache2/conf/server.crt:ro
          - /etc/ssl/private/ssl-cert-snakeoil.key:/usr/local/apache2/conf/server.key:ro
        pull: yes
        purge_networks: yes
        restart_policy: "always"
        container_default_behavior: "compatibility"

    - name: nextcloud storage (clear)
      file:
        path: /opt/nextcloud-storage.sh
        state: absent

    - name: nextcloud storage (set)
      lineinfile:
        path: /opt/nextcloud-storage.sh
        create: yes
        owner: root
        group: root
        mode: '0500'
        line: "{{ item }}"
      with_items:
        - "#!/bin/bash"
        - "# ensure files_external is enabled"
        - "docker exec --user www-data nextcloud_application php occ app:enable files_external"
        - " "
        - "# check bucket against existing storage"
        - "docker exec --user www-data nextcloud_application php occ files_external:list | grep --quiet 'cloud-storage'"
        - "  "
        - "# if doesn't exist, create"
        - "if [ $? -ne 0 ]"
        - "then"
        - "  echo 'Creating cloud storage in Nextcloud'"
        - "  docker exec --user www-data nextcloud_application php occ files_external:create -c bucket={{ gcp_project_prefix }}-bucket-data-{{ gcp_project_suffix }} -c hostname=storage.googleapis.com -c port=443 -c region=auto -c use_ssl=true -c use_path_style=true -c key={{ bucket_user_id }} -c secret={{ storage_key.json.payload.data | b64decode }} cloud-storage amazons3 amazons3::accesskey"
        - "  STORAGE_ID=$(docker exec --user www-data nextcloud_application php occ files_external:list | awk '/cloud-storage/ {a=$2}END{print a}')"
        - "  docker exec --user www-data nextcloud_application php occ files_external:option $STORAGE_ID enable_sharing true"
        - "else"
        - "  echo 'cloud storage exists, skipping.'"
        - "fi"

    - name: wait for nextcloud 200OK
      uri:
        url: "https://127.0.0.1:443/"
        status_code: 200
        validate_certs: no
      register: nc_wait_result
      until: nc_wait_result.status == 200
      retries: 180
      delay: 1

    - name: nextcloud storage (execute)
      shell:
        cmd: /opt/nextcloud-storage.sh
      args:
        executable: /bin/bash

    - name: nextcloud backup playbook (clear)
      file:
        path: /opt/nextcloud-backup.yml
        state: absent

    - name: nextcloud backup playbook (set)
      lineinfile:
        path: /opt/nextcloud-backup.yml
        create: yes
        owner: root
        group: root
        mode: '0640'
        line: "{{ item }}"
      with_items:
        - "---"
        - "- name: nextcloud-to-cloudstorage.yml"
        - "  hosts: localhost"
        - "  gather_facts: false"
        - "  collections:"
        - "    - oracle.oci"
        - "  tasks:"
        - "  "
        - "    - name: archive nextcloud locally"
        - "      archive:"
        - "        path: \"/opt/{{ '{{ item }}' }}\""
        - "        dest: \"/opt/{{ '{{ item }}' }}_backup.tar.gz\""
        - "        format: gz"
        - "        owner: root"
        - "        group: root"
        - "        mode: '0640'"
        - "      with_items:"
        - "        - nextcloud"
        - "        - nextcloud_db"
        - "   "
        - "    - name: Retrieve GCS Token"
        - "      uri:"
        - "        url: http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token"
        - "        method: GET"
        - "        headers:"
        - "          Metadata-Flavor: Google"
        - "        return_content: yes"
        - "      register: gcs_token_resp"
        - "     "
        - "    - name: upload nextcloud archive to storage"
        - "      uri: "
        - "        url: \"https://storage.googleapis.com/upload/storage/v1/b/{{ gcp_project_prefix }}-bucket-{{ gcp_project_suffix }}/o?uploadType=media&name=\""
        - "        timeout: 720"
        - "        method: POST"
        - "        src: \"/opt/{{ '{{ item }}' }}_backup.tar.gz\""
        - "        return_content: yes "
        - "        headers: "
        - "          Authorization: \"Bearer {{ gcs_token_resp.json.access_token }}\""
        - "      with_items: "
        - "        - nextcloud "
        - "        - nextcloud_db "

    - name: nextcloud backup systemd timer
      blockinfile:
        path: /etc/systemd/system/nextcloud-backup.timer
        create: yes
        owner: root
        group: root
        mode: '0644'
        block: |
          [Unit]
          Description=Archives and copies nextcloud_application and nextcloud_database containers to cloud storage
          [Timer]
          OnUnitActiveSec=12h
          Unit=nextcloud-to-cloudstorage.service
          [Install]
          WantedBy=multi-user.target

    - name: nextcloud backup systemd service
      blockinfile:
        path: /etc/systemd/system/nextcloud-backup.service
        create: yes
        owner: root
        group: root
        mode: '0644'
        block: |
          [Unit]
          Description=Archives and copies nextcloud_application and nextcloud_database containers to cloud storage
          After=network.target
          [Service]
          ExecStart=/usr/local/bin/ansible-playbook /opt/nextcloud-backup.yml
          Type=simple
          Restart=no
          [Install]
          WantedBy=multi-user.target

    - name: nextcloud backup systemd start/enable
      systemd:
        name: "nextcloud-backup.{{ item }}"
        daemon_reload: yes
        state: started
        enabled: yes
      with_items:
        - service
        - timer
